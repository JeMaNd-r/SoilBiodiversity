---
title: "Soil Biodiversity SDMs"
author: "Romy Zeiss"
date: "12/3/2021"
output: 
  html_document:
      toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)

library(CoordinateCleaner)
library(rgbif)
library(taxize)

library(raster)
library(sp)
library(extremevalues)
library(sdmpredictors)

library(biomod2) # also to create pseudo-absences
library(snowfall) # for parallelization
library(SSDM)

here::here()
```

This document works as a pipeline document from which several scripts will be runned. The general structure follows the table of content (see also Fig. 1).


```{r, echo=F}
DiagrammeR::grViz("digraph {
  graph [layout = dot, rankdir = TB]
  
  node [shape = rectangle]        
  rec1 [label = 'Step 1. Biodiversity Data']
  rec2 [label = 'Step 2. Environmental Data']
  rec3 [label =  'Step 3. Species Distribution Models (SDMs)']
  rec4 [label = 'Step 4. Diversity Maps']
  
  # edge definitions with the node IDs
  rec1 -> rec3;
  rec2 -> rec3;
  rec3 -> rec4
  }",
  height = 500)
```
Figure 1: Workflow to create Species Distribution Models (SDMs) of several soil taxa.


# Biodiversity data

First, we have to get the biodiversity data that is, occurrence data on diverse soil taxa. Second, we need to get all data into the same data format, before we can merge all taxa together in a third step.

## Download

We use different data sources to download occurrence data. Same have to be downloaded manually.

### Download using "taxize" package

The *taxize* package is searching in several databases for a specific taxon name, and simultaneously checks for spelling mistakes/ typos.

First, we define parameters specifying out search for occurrence data.

```{r, echo=TRUE}
# Name of the taxon we are interested in
Taxon_name <- "Crassiclitellata"

# Type of rank of the Taxon_name
Taxon_rank <- "order"

# geographic extent
Search_polygon <- "POLYGON((-28.94532 66.07036, -23.32032 29.18799, 38.55468 31.61348, 51.91406 43.80071, 56.83593 62.08195, 44.17968 72.69797, 7.61718 74.29467, -28.94532 66.07036))" 

# create vector graph object called Border_EU for plotting
Border_EU <- borders(database="world",colour = "black",fill = "gray50",  
                 xlim = c(-23, 60), 
                 ylim = c(31, 75))

# geographic extent of Europe
extent_Europe <- c(-23, 60, 31, 75)

# number of records that will be downloaded (max. 100,000)
No_records <- 100000

# do we want to download (new) occurrence records?
checkDownload_rawData <- FALSE

# do we want to save the cleaned data? If so, say TRUE
checkSave_cleanData <- TRUE

# do we want to save the cleaned environmental data?
checkSave_precitor <- FALSE

# define the species you wanted names
speciesNames <- read.csv(file=paste0(here::here(), "/doc/Species_list_", Taxon_name, ".csv"))

# define names of predictor variables
predictorNames <- c("bio1", "bio2", "bio3", "bio4", "bio5", "bio6", "bio7", "bio8", "bio9", "bio10", "bio11", "bio12", "bio13", "bio14", "bio15", "bio16", "bio17", "bio18", "bio19" , "Latitude")

# define first species
spID <- speciesNames[1, "SpeciesID"]
```

Next, we run the script to download and clean the data. We use the package CoordinateCleaner to identify occurrence records with geospatial issues. We also remove records collected before 1990. 

Note: If we download all available data (or the maximum limit of 100,000), it will take a while. If GBIF has more than 100,000 occurrence records, we need to download the data in several steps.

```{r, include=FALSE}
source("Download_occurrences.R")
```

```{r}
source("Clean_occurrences.R")
```


For the order Crassiclitellata, we have many occurrences in the Netherlands (countryCode="NL"), but most of them have a too high coordinateUncertainty (more than 1km), and/or are not at the species level, but at the family level only. They were therefore excluded and appear as a "red cloud" on the map above.


### Load dataset that was prepared in ArcGIS

Alternatively, we use a dataset on earthworm occurrences that was prepared with ArcGIS.

```{r}
#read.csv()
```


### Download from GBIF

We additionally download data from GBIF based on a pre-defined species list that contains only soil-living taxa (whenever it was possible to separate them from aquatic taxa). From the taxa in the species list, we first identify the GBIF taxonomic key, before we download all data based on these keys.

```{r, include=F}
#with rgbif...
```


## Harmonization

To get all biodiversity data into the same format, we reduce available occurrence data to presence/absence per grid cell. The grid we use has a resolution of 1kmÂ².

```{r}
# Create a template dataframe with headers (and structure) but no rows
df.occ <- tibble(Latitude=1.1, Longitude=1.1, 
                 Species="Species", Database="Database")[0,]
```


## Merging

We merge occurrences of taxa belonging to the same group of organism into one table and merge with the gridcell identifiers (GridID). That way it will be easier to build the ensemble models later on.

First, we create again a dataframe with the pre-defined structure for the data.

```{r}
df.taxa <- tibble(GridID=1)[0,]
```

Then, we add each species as a column to that dataframe.

```{r}

```



# Environmental data

We selected the environmental variables according to the literature. After loading the data, we check for colinearity between the variables. We remove variables that show colinearity of more than XXX. 

## Download

We download the environmental variables manually. Table 1 shows the respective Reference and links.


+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
| Predictor | Full name | Unit  | Resolution | CRS   | Range | DOI   | Reference | Link  |
+===========+===========+=======+============+=======+=======+=======+===========+=======+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+
|           |           |       |            |       |       |       |           |       |
+-----------+-----------+-------+------------+-------+-------+-------+-----------+-------+

: Table 1: Selected environmental variables. CRS - Coordinate Reference System

We may need to extract point-specific (climatic) values.

```{r, include=TRUE}
source("Extract_predictor.R")
```


After download, we load the data in R, combine them into one table, and check for correlation.

## Harmonization

The environmental variables all come with different resolution and coordinate reference systems. We transform all variables into a 1km x 1km grid with WGS84 as coordinate reference system. 

Because this is computationally intensive - especially in R - we do this in ArcGIS by creating a fishnet grid across Europe, and adding all variables to that grid. We get one table (GridID and variable value) for each variables. 

If we merge these tables in ArcGIS, we will get 0 values instead of NA. Therefore, we decided to merge the individual tables in R in the following.

## Merging

We start with the creation of the preferred output dataframe.

```{r}
df.env <- tibble(GridID=1)[0,]
```

```{r, echo=F}
source("Prepare_predictors.R")
```

Now, we can add all variables we want to include in our models to this dataframe.


## Check for colinearity

Before we start with the models, we check for colinearity between our environmental variables.

```{r}
#corrplot::corrplot(cor(df.env))
```


The selected environmental variables will be called **predictors** hereafter. We save the names of those selected variables into a vector for later.

```{r}
covarsNames <- predictorNames 
```


# Model input

## Background data or pseudo-absences

We create background data (pseudo-absences) for the different modeling approaches. The selected methods to create background data were chosen according to Barbet-Massin et al. (2012).

* large number (e.g. 10,000) of pseudo-absences with 
  * equal weighting for presences and absences when using regression techniques (e.g. generalised linear model and generalised additive model); 
  * averaging several runs (e.g. 10) with fewer pseudo-absences (e.g. 100) with equal weighting for presences and absences with multiple adaptive regression splines and discriminant analyses; 
  * using the same number of pseudo-absences as available presences (averaging several runs if few pseudo-absences) for classification techniques such as boosted regression trees, classification trees and random forest 
* random selection of pseudo-absences when using regression techniques and 
* random selection of geographically and environmentally stratified pseudo-absences when using classification and machine-learning techniques

```{r}
source("Create_backgroundData.R")
```


## Merging biodiversity and environmental data

```{r}
# add environmental data to presence data
env <- read.csv(file=paste0(here::here(), "/results/EnvPredictor_", Taxon_name, ".csv"))
occ <- read.csv(file=paste0(here::here(), "/results/Occurrences_", Taxon_name, ".csv"))
occ.env <- cbind(occ, env)

write.csv(occ.env, file=paste0(here::here(), "/results/OccEnv_", Taxon_name, ".csv"), row.names = F)
```

If you get an error message here regarding the length (nrow) of the dataframes, check if you extracted the environmental values with the selected occurrences.

## Split data into training, testing, and validation data

Split the dataset into training (60%), testing (20%) and validation (20%) data. In the same step, get the data into the right data format.

```{r}
source("Prepare_input.R")
```


## Define model parameters

```{r}

```


# Modelling

## Species Distribution Models

```{r, include=F}
# decide how many CPU to use for parallelization
setCPU <- 5

source(file=paste0(here::here(), "/src/SDMs.R"))
```

```{r, include=F}

source(file=paste0(here::here(), "/src/SDMs.R"))
```

# Repeat for all other taxa

## (Earthworms)

## Collembola

## Nematoda

## Fungi

## Bacteria

## Microarthropods (excluding Collembola)


# Ensemble model

## Model output


# Results and Visualization

## Input data

```{r}
dat_cl <- read.csv(file=paste0(here::here(), "/results/Occurrences_", Taxon_name, ".csv"))

table(dat_cl$species)
```


## Individual SDMs

```{r, include=F}
source("Result_SDMs.R")
```


## Diversity per group


```{r, include=F}
source("Result_richness_perGroup.R")
```

## Total diversity

```{r, include=F}
source("Result_richness.R")
```

## Model performance

```{r}

```

